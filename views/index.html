<!DOCTYPE html>

<head>

	<meta charset="utf-8">

	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>White Rose Taxi</title>

	<link rel="stylesheet" href="https://cdn.shopify.com/s/files/1/1490/7900/t/3/assets/simple.min.css" />

	<link rel="stylesheet" href="https://cdn.shopify.com/s/files/1/1490/7900/t/3/assets/jquery.mobile.icons.min.css" />

	<link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile.structure-1.4.5.min.css" />

	<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>	

	<script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

	<meta name="google-signin-scope" content="profile email">

    <meta name="google-signin-client_id" content="948345909344-tv4s24h5701sjicbeqcs9ai2beaaqof6.apps.googleusercontent.com">

    <script src="https://apis.google.com/js/platform.js" async defer></script>

	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>

	<style>

		[data-role=page]{height: 100% !important; position:relative !important;}

		[data-role=footer]{bottom:0; position:fixed !important; top: auto !important; width:100%;}

	</style>

</head>

<body>

	<!-- Home Page 1 //-->

	<div data-role="page" id="homePage">

		<div data-role="header">

			<h1>White Rose Taxi</h1>

		</div>

		<div data-role="main" class="ui-content">

			<div style="text-align: center;"><img style="border-radius: 10px;" src="https://cdn.shopify.com/s/files/1/1490/7900/t/3/assets/WhiteRoseTaxiLogo.png" /></div>

			<div id="my-signin2"></div>

  <script>

function onSuccess(googleUser) {

console.log('Logged in as: ' + googleUser.getBasicProfile().getName());

}

function onFailure(error) {

console.log(error);

}

function renderButton() {

gapi.signin2.render('my-signin2', {

'scope': 'profile email',

'width': 240,

'height': 50,

'longtitle': true,

'theme': 'dark',

'onsuccess': onSuccess,

'onfailure': onFailure

});

}

</script>

    <script>

function onSignIn(googleUser) {

// Useful data for your client-side scripts:

var profile = googleUser.getBasicProfile();

console.log("ID: " + profile.getId()); // Don't send this directly to your server!

console.log('Full Name: ' + profile.getName());

console.log('Given Name: ' + profile.getGivenName());

console.log('Family Name: ' + profile.getFamilyName());

console.log("Image URL: " + profile.getImageUrl());

console.log("Email: " + profile.getEmail());

// The ID token you need to pass to your backend:

var id_token = googleUser.getAuthResponse().id_token;

console.log("ID Token: " + id_token);

};

</script>

			<a style="text-decoration: none;" href="#orderPage"> 

				<button>ORDER TAXI</button> </a> 

				<button>FARE ESTIMATE <br /><span style="font-size: 12px;">(Coming Soon)</span></button> <a style="text-decoration: none;" href="tel:717.852.7673"> <button>CONTACT US</button> </a>

			<ul style="font-size: 12px;">

				<li>$1.80 for the first 1/5th of a mile</li>

				<li>$1.90 for each additional mile.</li>

				<li>$0.38 per minute wait time.</li>

				<li>$5.00 for each returned item.</li>

				<li>$1.00 for night time differential.</li>

				<li>We now take credit cards its a $10.00 minimum</li>

			</ul>

			<p style="font-size: 14px;">For more information please visit <a href="https://www.whiterosetaxi.com/" class="ui-link">White Rose Taxi.</a></p>

			<fieldset data-role="fieldcontain" data-type="horizontal">

				<legend>Cache settings:</legend>

				<input type="radio" name="radio-choice-a1" id="radio-choice-a1" value="on" checked="checked" /> <label for="radio-choice-a1">On</label> <input type="radio" name="radio-choice-a1" id="radio-choice-b1" value="off" /> <label for="radio-choice-b1">Off</label>

			</fieldset>

		</div>

		<div data-role="footer" data-type="footer">

			<span style="padding: 2px;"> &nbsp;© 2018 White Rose Taxi</span>

			<span id="statusFooter" style="text-align: right; font-size: 10px;"></span>

		</div>

	</div>

	<!-- End Home Page 1 //-->

	<!-- Begin Order Page 2//-->

	<div data-role="page" id="orderPage">

		<div data-role="header">

			<h1>Order Taxi</h1>

		</div>

		<div data-role="main" class="ui-content">

			<form class="ui-field-contain" name="taxiOrderForm" id="taxiOrderForm">

				<fieldset>

					<label for="name">Name:</label>

					<input type="text" name="name" id="name" value="" /> 

					<label for="phone">Phone:</label>

					<input type="tel" name="phone" id="phone" value="" placeholder="Required" required="" />

					<label for="pickup">Pickup:</label>

					<input type="search" class="autocomplete" name="pickup" id="pickup" value="" placeholder="Required" required="" />

					<label for="destination">Destination:</label>

					<input type="search" class="autocomplete" name="destination" id="destination" value="" placeholder="Required" required="" />

					<label for="info">Additional Information (Optional):</label>

					<textarea name="info" type="textarea" cols="75" rows="5" id="info" placeholder="What else should we know?"></textarea>

					<input type="hidden" name="uid" id="uid" value="" />

				</fieldset>

			</form>

			<a style="text-decoration: none;" href="#waitPage"><button id="send" class="ui-shadow ui-btn ui-corner-all" type="submit">SEND</button></a>

		</div>

		<div data-role="footer" data-type="footer">

			<span style="padding: 2px;"> &nbsp;© 2018 White Rose Taxi</span>

			<span id="statusFooter" style="text-align: right; font-size: 10px;"></span>

		</div>

	</div>


	<script type="text/javascript">

	

	$(document).ready(function(){

		

		

		

		var orderId; //order ID

		

		try{

		

		//generate Unique Identifier

		

		function uid() {

		 // Math.random should be unique because of its seeding algorithm.

		 // Convert it to base 36 (numbers + letters), and grab the first 9 characters

		 // after the decimal.

		 return new Date().getTime() + '_' + Math.random().toString(36).substr(2, 9);

		}

		

		//set unique Id for order

		

		function setUid(){

		

			orderId = uid();		

			$('#uid').val(orderId);

			

			console.log('new id set: ' + orderId);

			

		}	

		

		setUid();

	

	

			//init socket

			

			var socket = io.connect('http://taxi-taximobile.7e14.starter-us-west-2.openshiftapps.com');

									

			socket.emit('init', 'New Client connected with ID: ' + orderId + ' : ' + $('#uid').val());

			socket.on('init',function(data){				

				console.log('Connection Established! orderId: ' + orderId + ' : ' + $('#uid').val());

				$('#statusFooter').html('Connection Established!');

			});	

			//receive order acknowledgement

			

			socket.on('order',function(data){

				console.log(data);

				$('#statusFooter').html(data);

			});

			

			//receive wait time

			socket.on('waitTime',function(data){

				console.log(data);				

				if(orderId == data.id){

					$('#waitingOnDispatch').hide();

					$('#time').show();
					
      //set wait time countdown
					
				setTimer(data.waitTime);
			
				}

				$('#statusFooter').html(data);

			});

			

			//receive order cancellation acknowledgement

			socket.on('cancel',function(data) {

			if(orderId == data){

				console.log('Cancel Request Received');

					setUid();

				}

				

			});

			

			//socket disconnect

			

			socket.on("disconnected", function () {

				console.log('Disconnected from Taxi Dispatch');

				$('#statusFooter').html('Disconnected from Taxi Dispatch');

				//alert('Disconnected from Taxi Dispatch');

			});

			//send order

			

			$('#send').click(function() {			

			

				socket.emit('order', JSON.parse(JSON.stringify($('#taxiOrderForm').serialize()))); //send order data from form

				console.log('Order Sent');

				$('#statusFooter').html('Order Sent');				

			

			//send ajax request to google script to send email of order and record order in spread sheet

			

			$.ajax({

				url : 'https://script.google.com/macros/s/AKfycbw590PKXYP2n5AX6HZ72K_gDjW4FnL_wsIVHLAqW6ukk38YGKXR/exec',

				type: "GET",

				data: $('#taxiOrderForm').serialize(),

				success: function (data) {

				

					//alert(data);

				

				},

				error: function (jXHR, textStatus, errorThrown) {

					//alert(errorThrown);

				}

			});

		});

		function startTimer(duration, display) { 
		
		var timer, minutes, seconds;
		timer = setInterval(function () { minutes = parseInt(duration / 60, 10); 
		
		seconds = parseInt(duration % 60, 10); 
		
		minutes = minutes < 10 ? "0" + minutes : minutes; 
		
		seconds = seconds < 10 ? "0" + seconds : seconds; 
		
		display.text(minutes + ":" + seconds); 
		
		if (--duration < 0) { 
			clearInterval(timer);
			
			WebPayInterface.notification('Taxi Status', 'Your Taxi Has Arrived'); //send mobile app notification when wait time expires
		
		 } 
		
		}, 1000); 
		
		}
		

		//count down timer

		function setTimer(mins) {

				display = $('#timer');

			startTimer((mins * 60), display);

		};
		

			//send order cancel request

		

			$('#cancelConfirmButton').click(function(){

			

				$('#waitingOnDispatch').show();

				$('#time').hide();

	

				socket.emit('cancel', orderId);

				console.log('Cancel Request Sent from: ' + orderId);

				$('#statusFooter').html('Cancel Request Sent.');

				

				//setUid();

				window.history.back();						

			

			});

		

		

		}catch (error){			

				console.log('Cannot connect to Taxi Dispatch Server\n\n Error: ' + error);				

		}

		

		});

		

	

	</script>


	<!-- End Order Page //-->

	<!-- Begin wait Page //-->

	<div data-role="page" id="waitPage">

		<div data-role="header">

			<h1>Taxi Order Status</h1>

		</div>

		<div data-role="main" class="ui-content">

			<div data-rel="dialog" data-transition="pop" id="waitingOnDispatch" style="text-align: center;">

				<img id="loader" src="https://cdn.shopify.com/s/files/1/1490/7900/t/3/assets/ajax-loader.gif" />

				<p>Waiting on response from dispatcher.</p>

			</div>

			<div id="time" style="text-align: center; display: none;">
      <p>Your taxi is on the way!</p>
				<h2>Wait Time:</h2>

				<h2 id="timer"></h2>

			</div>			

				<a href="#cancelConfirm" style="text-decoration: none;" data-rel="popup" data-position-to="window"><button style="background-color: red; color: white;" id="cancelOrder">CANCEL</button></a>


				<!-- Popups for lightbox images -->

				<div id="cancelConfirm" data-role="popup" data-overlay-theme="a" style="padding: 20px;">

					<label><h2>Are you sure you want to cancel?</h2></label>

					<br />

					<a href="#" style="text-decoration: none;" data-rel="back"><button style="background-color: green; color: white;" id="cancelConfirmButton"><strong>Accept</strong></button></a>

					<a href="#" style="text-decoration: none;" data-rel="back"><button style="background-color: red; color: white;"><strong>Cancel</strong></button></a>

				</div>


		</div>

		<div data-role="footer" data-type="footer">

			<span style="padding: 2px;"> &nbsp;© 2018 White Rose Taxi</span>

			<span id="statusFooter" style="text-align: right; font-size: 10px;"></span>

		</div>

	</div>


	<script>		

		

		function initAutocomplete() {

		 // Create the autocomplete object, restricting the search to geographical

		 // location types.

		 autocomplete = new google.maps.places.Autocomplete(

		 /** @type {!HTMLInputElement} */(document.getElementById('pickup')),

		 {types: ['geocode']});

		

		 // When the user selects an address from the dropdown, populate the address

		 // fields in the form.

		 autocomplete.addListener('place_changed', fillInAddress);

		 }

		

		 function fillInAddress() {

		 // Get the place details from the autocomplete object.

		 var place = autocomplete.getPlace();

		

		 }

	</script>

	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAVzTnX1B1vuuP9n6CYPXvxporMgoDCl-Q&libraries=places&callback=initAutocomplete" async defer=></script>

</body>

</html>
